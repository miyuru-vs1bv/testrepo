name: Trigger Deployment on PR Label

on:
  pull_request:
    types: [closed]

permissions:
  pull-requests: write

jobs:
  validate-and-trigger:
    #if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Check for label on PR
        id: check_label
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber;
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
            } else {
              throw new Error("Unsupported event type");
            }
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            const hasDeployDevLabel = pr.labels.some(label => label.name.toLowerCase() === 'deploy:dev');
            if (!hasDeployDevLabel) {
              throw new Error(`PR #${prNumber} does not have the 'deploy:dev' label.`);
            }
            console.log(`PR #${prNumber} has the 'deploy:dev' label.`);

      - name: Set and Validate Deployment Variables
        id: vars
        env:
          sha_workflow: ${{ github.event.workflow_run.head_commit.id }}
        run: |
          echo "Validating deployment variables..."
          # Force environment to development
          ENVIRONMENT="development"
          echo "environment=${ENVIRONMENT}" >> "$GITHUB_OUTPUT"
          
          # Validate that the merge commit SHA exists and use it as the country config image tag.
          if [ -z "${{ sha_workflow }}" ]; then
            echo "Error: Merge commit SHA not found."
            exit 1
          fi

          MERGE_SHA="${{ sha_workflow }}"
          # Extract the short commit id (first 7 characters)
          SHORT_SHA="${MERGE_SHA:0:7}"
          echo "countryconfig_image_tag=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "Using short commit SHA as country config image tag: ${SHORT_SHA}"

      - name: Comment on PR about Development Deployment
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.number }}
        with:
          script: |
            // Construct GitHub Action Run URL using environment variables
            const serverUrl = process.env.GITHUB_SERVER_URL;
            const runId = process.env.GITHUB_RUN_ID;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const actionRunUrl = `${serverUrl}/${owner}/${repo}/actions/runs/${runId}`;
            
            for (const pr of prs) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: process.env.PR_NUMBER,
                body: `ðŸš€ Deploying to development environment. [View Action Run](${actionRunUrl}) ðŸ˜Ž`
              });
              console.log(`Comment added to PR #${process.env.PR_NUMBER}`);
            }


      - name: Trigger Downstream Deployment
        if: ${{ github.event_name != 'workflow_dispatch' }}
        uses: peter-evans/repository-dispatch@v3
        with:
          event-type: downstream_deployment
          client-payload: |
            {
              "environment": "development",
              "core-image-tag": "tonga/devops",
              "countryconfig-image-tag": "${{ steps.vars.outputs.countryconfig_image_tag }}"
            }
